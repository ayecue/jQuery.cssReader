var classInstance=function(){var e=this;this.container={keys:[]};this.add=function(t,n,r,i,s){if(!(n in e.container)){e.container[n]=[];e.container.keys.push(n)}e.container[n].push({lastPriority:cssReader.getClassPriority(t),classString:t,classPath:r,attrIndex:typeof i=="number"?i:false});s.add(t,n)}};var refInstance=function(){var e=this;this.container={keys:[]};this.add=function(t,n){if(!(t in e.container)){e.container[t]=[];e.container.keys.push(t)}e.container[t].push(n)}};var attrInstance=function(){var e=this;this.container=[];this.add=function(t,n,r){if(!(t in e.container))e.container[t]={keys:[]};if(typeof e.container[t][n]=="function")n=attrInstance.debugPrefixString+n;if(!(n in e.container[t])){e.container[t][n]=[];e.container[t].keys.push(n)}e.container[t][n].push(r)}};attrInstance.debugPrefixString="db_";attrInstance.debugPrefixPattern=new RegExp("^"+attrInstance.debugPrefixString,"i");attrInstance.debugPrefixFilter=function(e){return e.replace(attrInstance.prefixPattern,"")};var compiledInstance=function(){var e=this;this.container={keys:[]};this.get=function(t,n,r){if(!(t in n.container))return false;if(!(t in e.container)){e.container[t]={keys:[]};e.container.keys.push(t);c=n.container[t];for(g=0,gl=c.length;g<gl;g++){a=r.container[c[g].attrIndex].keys;for(j=0,jl=a.length;j<jl;j++){ac=r.container[c[g].attrIndex][a[j]];ai=cssReader.isAttrImportant(ac);if(!(a[j]in e.container[t])){e.container[t].keys.push(a[j]);e.container[t][a[j]]={attrPriority:c[g].lastPriority,attrValue:ac,attrPath:c[g].classPath,attrClass:c[g].classString,attrImportant:ai}}else if(e.container[t][a[j]].attrImportant<ai||e.container[t][a[j]].attrPriority<=c[g].lastPriority&&e.container[t][a[j]].attrImportant==ai){e.container[t][a[j]]={attrPriority:c[g].lastPriority,attrValue:ac,attrPath:c[g].classPath,attrClass:c[g].classString,attrImportant:ai}}}}return e.container[t]}else return e.container[t]}};var cssReader=function(e){var t=this;var n={targetUrl:"",plainCss:"",fetchedCss:""};this.classIns=new classInstance;this.refIns=new refInstance;this.compiledIns=new compiledInstance;this.attrIns=new attrInstance;this.d=$.extend(n,e);this.setUrl=function(e){t.d.targetUrl=e};this.setCss=function(e){t.d.plainCss=cssReader.getCompressedCss(e)};this.fetchCss=function(){t.d.fetchedCss=t.d.plainCss.match(/([#.\w\s:,>\-_*"=\[\]]+){(?:[^}]*)}/gi)};this.fetchCssFilter=function(e){filterString=typeof e!="string"?filterString=e.join("|"):e;t.d.fetchedCss=t.d.plainCss.match(new RegExp('([#.\\w\\s:,>\\-_*"=\\[\\]]+){(?:[^}]*(?:'+filterString+")+[^}]*)}","gi"))};this.get=function(e){if(t.d.targetUrl){return $.ajax({url:t.d.targetUrl,success:function(n){t.setCss(n);e?t.fetchCssFilter(e):t.fetchCss()}})}};this.read=function(e){currentCssString=e?e:t.d.fetchedCss;for(var n=0,r=currentCssString.length;n<r;n++){matches=/([#.\w\s:,>\-_*"=\[\]]+){([^}{*\/]+:[^}{]*[^*\/]*?;?)+}/gi.exec(currentCssString[n]);classNames=matches[1];classAttr=matches[2];if(classAttr&&classAttr.length>0){attrSplit=classAttr.split(";");attrContainerLength=t.attrIns.container.length;for(var i=0,s=attrSplit.length;i<s;i++){attrString=attrSplit[i];if(attrString.length>0){splittedAttrString=attrString.split(":");splittedKey=cssReader.getTrimStr(splittedAttrString[0]);splittedValue=cssReader.getTrimStr(splittedAttrString[1]);if(splittedKey.length>0&&splittedValue.length>0)t.attrIns.add(attrContainerLength,splittedKey,splittedValue)}}if(i>0){classParentFilter=classNames.indexOf(",")!=-1?classNames.split(","):[classNames];for(var o=0,u=classParentFilter.length;o<u;o++){classString=classParentFilter[o];if(classString.length>0){trimmedClassString=cssReader.getTrimStr(classString);try{var a=cssReader.getClassPath($(trimmedClassString))}catch(f){var a=false}if(typeof a=="string")t.classIns.add(trimmedClassString,cssReader.getClassHash(a),a,attrContainerLength,t.refIns);else if(a===false)t.classIns.add(trimmedClassString,cssReader.getClassHash(trimmedClassString),false,attrContainerLength,t.refIns);else{for(var l=0,c=a.length;l<c;l++)t.classIns.add(trimmedClassString,cssReader.getClassHash(a[l]),a[l],attrContainerLength,t.refIns)}}}}}}return true};this.readFilter=function(e){filterString=typeof e!="string"?filterString=e.join("|"):e;filterReg=new RegExp("("+filterString+"):[^}{]*[^*\\/]*?;","gi");filteredCss=[];for(var n=0,r=t.d.fetchedCss.length;n<r;n++){if(t.d.fetchedCss[n].match(filterReg))filteredCss.push(t.d.fetchedCss[n])}return t.read(filteredCss)};this.search=function(e,n){for(var r=0,i=t.refIns.container.keys.length;r<i;r++){for(var s=0,o=t.refIns.container[t.refIns.container.keys[r]].length;s<o;s++){cc=t.compiledIns.get(t.refIns.container[t.refIns.container.keys[r]][s],t.classIns,t.attrIns);if(n?n in cc:true)e.call(t,cc);else if(attrInstance.debugPrefixString+n in cc)e.call(t,cc)}}};this.scrape=function(e){$.when(t.get()).done(function(){$.when(t.read()).done(function(){if(e)e.call(t,t.d)})})};this.scrapeFilter=function(e,n,r,i){$.when(r?t.get(n):t.get()).done(function(){$.when(i?t.readFilter(n):t.read()).done(function(){if(e)e.call(t,t.d)})})}};cssReader.getTrimStr=function(e){return e.replace(/^\s+|\s+$/g,"")};cssReader.getCompressedCss=function(e){return e.replace(/\/\*[\s\S]+?\*\//g,"").replace(/[^\S][\s\n\r]*[^\S]/g,"")};cssReader.getClassHash=function(e){if(e.lenght==0)return false;hash=0;for(i=0,il=e.length;i<il;i++){hash=(hash<<5)-hash+e.charCodeAt(i);hash=hash&hash}return"md"+hash.toString()};cssReader.getClassPath=function(e){if(!e[0])return false;allClassPath=[];for(i=0,il=e.length;i<il;i++){current=e.eq(i);parents=current.parents("*");classPath="";for(j=0,jl=parents.length;j<jl;j++){classString=(className=parents[j].className)?"."+className.replace(/\s/g,"."):"";idString=(idName=parents[j].getAttribute("id"))?"#"+idName.replace(/\s/g,"#"):"";classPath=parents[j].tagName.toLowerCase()+idString+classString+" "+classPath}allClassPath.push(classPath.replace(/\s/gi," > ")+e[i].tagName.toLowerCase()+((className=e[i].className)?"."+className.replace(/\s/g,"."):"")+((idName=e[i].getAttribute("id"))?"#"+idName.replace(/\s/g,"#"):""))}return allClassPath.length>0?allClassPath:false};cssReader.getClassPriority=function(e){rating=0;rating+=(matches=e.match(/#[^\s\.#]+/gi))?matches.length*100:0;rating+=(matches=e.match(/\.[^\s\.#]+/gi))?matches.length*10:0;rating+=(matches=e.replace(/[#.][^\s\.#]+/ig,"").match(/[^\s]+(?=#|\.)?/gi))?matches.length*1:0;return rating};cssReader.isAttrImportant=function(e){return/!important$/.test(e)}
